---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.8.0
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
import pandas as pd
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.image as image
import os
import shutil
import random
import re
import tensorflow as tf
import numpy as np
import json
```

```{python}
basedir = '..'
```

```{python}
os.path.join(*['..', 'll'])
```

```{python}
df = pd.read_csv(os.path.join(basedir, 'train.csv'))
```

```{python}
# 11
```

```{python}
max(df["class"])
```

```{python}
plt.imshow(image.imread(os.path.join(basedir, 'train', '15309.jpg')))
```

```{python}
# range scarpe: [15309, 28206] class [1849, 2834]
```

```{python}
df[df["class"] == 1849].iloc[0]
```

```{python}
df.iloc[28206]
```

```{python}
efb3 = tf.keras.applications.EfficientNetB3(
    weights="imagenet"
)
```

```{python}
im = tf.keras.preprocessing.image.load_img(
    os.path.join(basedir, 'train', '15309.jpg'),
    target_size=(300, 300, 3)
)
```

```{python}
imarr = tf.keras.preprocessing.image.img_to_array(im)
imarr = np.array([imarr])  # Convert single image to a batch.
```

```{python}
pred = efb3.predict(imarr)
```

```{python}
plt.plot(pred[0])
```

```{python}
predDF = pd.DataFrame(pred[0], columns=["value"])
predDF
```

```{python}
predDF[predDF["value"] > 0.1]
```

```{python}
imagenet_classes[predDF["value"].argmax()]
```

```{python}
imagenet_classes[630]
```

```{python}
# download https://gist.githubusercontent.com/yrevar/942d3a0ac09ec9e5eb3a/raw/238f720ff059c1f82f368259d1ca4ffa5dd8f9f5/imagenet1000_clsidx_to_labels.txt
# and rename to imagenet_classes.json
with open('imagenet_classes.json', 'r') as ha:
    text = ha.read()
    text = re.sub('{?\s*([0-9]+)\s*:\s*[\'"](.*?)[\'"][,}]', '"\g<1>":"\g<2>",\n', text)
    text = text[0:-2]
    text = '{\n'+text+'\n}'
    #text = text.replace("'", '"')
    imagenet_classes = json.loads(text)
    imagenet_classes = {int(k):v for k,v in imagenet_classes.items()}
imagenet_classes
```

```{python}
def predimg(number):
    im = tf.keras.preprocessing.image.load_img(
        os.path.join(basedir, 'train', f'{number}.jpg'),
        target_size=(300, 300, 3)
    )
    imarr = tf.keras.preprocessing.image.img_to_array(im)
    imarr = np.array([imarr])  # Convert single image to a batch.
    pred = efb3.predict(imarr)
    return imagenet_classes[pred[0].argmax()]
```

```{python}
#[15309, 28206]
x = 3
plt.imshow(image.imread(os.path.join(basedir, 'train', f'{x}.jpg')))
predimg(x)
```

```{python}

```
