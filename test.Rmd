---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.8.0
  kernelspec:
    display_name: 'Python 3.8.5 64-bit (''venv'': venv)'
    name: python_defaultSpec_1609333253733
---

```{python}
import pandas as pd
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.image as image
import os
import shutil
import random
import re
import tensorflow as tf
import numpy as np
import json
import time
import sklearn.model_selection
```

```{python}
classes = ['shoe','trousers','jacket','sweatshirt']
```

```{python}
def getModel(num_classes):
    basemodel = efb3 = tf.keras.applications.EfficientNetB3(
        weights="imagenet",
        include_top=False
    )
    basemodel.trainable = False
    model = tf.keras.models.Sequential()
    model.add(basemodel)
    model.add(tf.keras.layers.GlobalAveragePooling2D())
    model.add(tf.keras.layers.Dropout(0.2))
    model.add(tf.keras.layers.Dense(num_classes, activation='softmax'))

    return model
```

```{python tags=c()}
mymodel = getModel(len(classes))
mymodel.summary()
```

```{python}
mymodel.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])
```

```{python}
jackets_filtered = pd.read_csv('jackets_filtered.csv', index_col=0)
jackets_filtered["class"] = "jacket"
jackets_filtered.head()
```

```{python}
scarpe_filtered = pd.read_csv('scarpe_filtered.csv', index_col=0)
scarpe_filtered["class"] = "shoe"
scarpe_filtered.head()
```

```{python}
sweatshirt_filtered = pd.DataFrame(os.listdir('../sweatshirt'), columns=["fname"])
sweatshirt_filtered["class"] = "sweatshirt"
sweatshirt_filtered.head()
```

```{python}
pantaloni_filtered = pd.DataFrame(os.listdir('../pantaloni'), columns=["fname"])
pantaloni_filtered["class"] = "trousers"
pantaloni_filtered.head()
```

```{python}
filtered_df = pd.concat([scarpe_filtered, pantaloni_filtered, sweatshirt_filtered, jackets_filtered])
```

```{python}
if not os.path.isfile('filtered_df.csv'):
    filtered_df.to_csv('filtered_df.csv')
```

```{python}
classes
```

```{python}
for current_class in classes:
    filtered_df[current_class] = (filtered_df["class"] == current_class).astype('int32')
```

```{python}
filtered_df.head()
```

```{python}
train_df, test_df = sklearn.model_selection.train_test_split(filtered_df, test_size=0.2, random_state=1000)
```

```{python}
train_df, validation_df = sklearn.model_selection.train_test_split(train_df, test_size=0.15, random_state=1000)
```

```{python}
train_df
```

```{python}
def loadImages(pathlist, basedir='.'):
    size = len(pathlist)

    batcharr = np.zeros(shape=(size, 300, 300, 3))

    for i in range(0,size):

        img_path = os.path.join(basedir, pathlist[i])

        im = tf.keras.preprocessing.image.load_img(
            img_path,
            target_size=(300, 300, 3)
        )
        imarr = tf.keras.preprocessing.image.img_to_array(im)
        imarr = tf.keras.applications.efficientnet.preprocess_input(imarr)

        batcharr[i] = imarr

    return batcharr
```

```{python}
train_df["fname"].values[0]
```

```{python}
imgs_loaded = loadImages(train_df["fname"].values, basedir='../train')
```

```{python}
imgs_loaded_validation = loadImages(validation_df["fname"].values, basedir='../train')
```

```{python}
validation_y = validation_df[["shoe", "trousers", "jacket", "sweatshirt"]].values
```

```{python}
train_y = train_df[["shoe", "trousers", "jacket", "sweatshirt"]].values
```

```{python tags=c()}
hist = mymodel.fit(imgs_loaded, train_y, epochs=5, verbose=True, batch_size=32,
                    validation_data=(imgs_loaded_validation, validation_y))
```

```{python}

```
